#!/bin/bash

# Install all dotfiles into the home directory

set -e
set -o pipefail

DOTFILES_ROOT="$(pwd)"

if [ -z "$1" ]; then
  DEST_ROOT=$HOME
else
  DEST_ROOT="$1"
fi

find "$DOTFILES_ROOT" -maxdepth 2 -name '*.symlink' -print0 | while IFS= read -r -d '' source
do
  dest="${DEST_ROOT}/.$(basename "${source%.*}")"

  if [ "$(basename "${source%.*}")" = "claude" ] && [ -n "$RUNNING_IN_DEVCONTAINER" ] && [ -e "$dest" ]; then
    echo "Skipping .claude symlink in devcontainer (already exists at $dest)"
    continue
  fi

  if [ -e "$dest" ]; then
    mv -fv "$dest" "${dest}.backup"
  fi

  ln -svf "$source" "$dest"
done

if ! fzf --zsh > /dev/null 2>&1; then
  fzf_version=$(fzf --version | cut -d " " -f 1)
  url_prefix="https://raw.githubusercontent.com/junegunn/fzf/refs/tags/$fzf_version/shell/"

  echo "Installing zsh files for fzf version $fzf_version"

  curl -fsSL "$url_prefix/key-bindings.zsh" -o fzf/key-bindings.zsh
  curl -fsSL "$url_prefix/completion.zsh" -o fzf/completion.zsh
fi

if command -v nvim > /dev/null 2>&1; then
  echo "Installing nvim plugins from lockfile"
  nvim --headless "+Lazy! restore" +qa
fi
