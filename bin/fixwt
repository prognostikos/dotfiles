#!/bin/bash

set -euo pipefail

# Detect environment
if [ -n "${RUNNING_IN_DEVCONTAINER:-}" ]; then
  ENV="container"
else
  ENV="host"
fi

# Try to get git info, but handle broken worktrees
if git rev-parse --git-common-dir &>/dev/null; then
  # Git commands work - we can use them
  GIT_COMMON_DIR="$(git rev-parse --git-common-dir)"
  MAIN_REPO="$(cd "$GIT_COMMON_DIR/.." && pwd)"
  CURRENT_DIR="$(git rev-parse --show-toplevel)"
else
  # Git commands fail - we're in a broken worktree
  # Use directory structure to find main repo
  CURRENT_DIR="$(pwd)"

  if [ -f .git ]; then
    # We're in a worktree - deduce main repo from directory name
    WORKTREE_NAME="$(basename "$CURRENT_DIR")"
    PARENT_DIR="$(dirname "$CURRENT_DIR")"
    PARENT_NAME="$(basename "$PARENT_DIR")"

    # Parent should be something like "mrclean-worktrees"
    # Main repo is sibling without "-worktrees"
    REPO_NAME="${PARENT_NAME%-worktrees}"
    GRANDPARENT_DIR="$(dirname "$PARENT_DIR")"
    MAIN_REPO="$GRANDPARENT_DIR/$REPO_NAME"

    if [ ! -d "$MAIN_REPO/.git" ]; then
      echo "Error: Could not find main repo at $MAIN_REPO"
      exit 1
    fi

    echo "Detected broken worktree: $WORKTREE_NAME"
    echo "Found main repo: $MAIN_REPO"
  else
    # Assume we're in main repo
    MAIN_REPO="$(pwd)"
    CURRENT_DIR="$MAIN_REPO"
  fi
fi

REPO_NAME="$(basename "$MAIN_REPO")"
PARENT_DIR="$(dirname "$MAIN_REPO")"

# Determine which worktree to fix
if [ -n "$WORKTREE_NAME" ]; then
  # Already determined (broken worktree case)
  echo "Using worktree: $WORKTREE_NAME"
elif [ "$CURRENT_DIR" == "$MAIN_REPO" ]; then
  # In main repo - need to select worktree
  readarray -t WORKTREES < <(git worktree list --porcelain |
    grep '^worktree' |
    awk '{print $2}' |
    tail -n +2 |
    xargs -n1 basename)

  if [ ${#WORKTREES[@]} -eq 0 ]; then
    echo "No worktrees found"
    exit 1
  elif [ ${#WORKTREES[@]} -eq 1 ]; then
    WORKTREE_NAME="${WORKTREES[0]}"
    echo "Found worktree: $WORKTREE_NAME"
  else
    # Use fzf to pick
    WORKTREE_NAME=$(printf '%s\n' "${WORKTREES[@]}" |
      fzf --prompt="Select worktree: ")
    if [ -z "$WORKTREE_NAME" ]; then
      echo "No worktree selected"
      exit 1
    fi
  fi
else
  # In working worktree - use current
  WORKTREE_NAME="$(basename "$CURRENT_DIR")"
  echo "Using current worktree: $WORKTREE_NAME"
fi

# Set paths based on environment
if [ "$ENV" == "container" ]; then
  MAIN_PATH="/workspaces/$REPO_NAME"
  WORKTREE_PATH="/workspaces/${REPO_NAME}-worktrees/$WORKTREE_NAME"
else
  MAIN_PATH="$MAIN_REPO"
  WORKTREE_PATH="$PARENT_DIR/${REPO_NAME}-worktrees/$WORKTREE_NAME"
fi

# Update gitdir pointer in main repo
echo "$WORKTREE_PATH/.git" > \
  "$MAIN_REPO/.git/worktrees/$WORKTREE_NAME/gitdir"

# Update .git file in worktree
echo "gitdir: $MAIN_PATH/.git/worktrees/$WORKTREE_NAME" > \
  "$WORKTREE_PATH/.git"

echo "âœ“ Worktree '$WORKTREE_NAME' configured for $ENV"
echo "  Main repo: $MAIN_PATH"
echo "  Worktree:  $WORKTREE_PATH"
