#!/bin/bash
set -euo pipefail

INPUT=$(cat)
CWD=$(echo "$INPUT" | jq -r '.cwd')

# Get git branch
BRANCH=$(cd "$CWD" && git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# Get tmux session (if in tmux)
TMUX_SESSION=$(tmux display-message -p '#S' 2>/dev/null || echo "")

# Build message
if [[ -n "$TMUX_SESSION" ]]; then
  MSG="$TMUX_SESSION [$BRANCH]"
else
  MSG="$BRANCH"
fi

# Detect if we're behind tmux and need DCS passthrough wrapping.
# Direct tmux: $TMUX is set. Behind tmux (e.g. devcontainer): $TERM or
# $RUNNING_IN_DEVCONTAINER signals passthrough is needed.
needs_passthrough() {
  [[ -n "${TMUX:-}" ]] ||
    [[ "${TERM:-}" == tmux* ]] ||
    [[ "${TERM:-}" == screen* ]] ||
    [[ -n "${RUNNING_IN_DEVCONTAINER:-}" ]]
}

# Find the controlling terminal - hook commands have stdout captured,
# so we must write escape sequences directly to the TTY.
TTY=$(tty 2>/dev/null) || TTY=""
if [[ -z "$TTY" || "$TTY" == "not a tty" ]]; then
  # Fall back to the pts that Claude Code's session is using
  for candidate in /dev/pts/0 /dev/tty; do
    if [[ -w "$candidate" ]]; then
      TTY="$candidate"
      break
    fi
  done
fi

if [[ -z "$TTY" ]]; then
  exit 0
fi

if needs_passthrough; then
  # Wrap OSC 777 in tmux DCS passthrough (ESC characters doubled inside)
  printf '\033Ptmux;\033\033]777;notify;Claude Code;%s ready\007\033\\' "$MSG" > "$TTY"
else
  printf '\033]777;notify;Claude Code;%s ready\007' "$MSG" > "$TTY"
fi
