#!/bin/bash

set -euo pipefail

# Usage message
usage() {
  echo "Usage: wt <branch-name> [base-branch]"
  echo "  Create a git worktree in a parallel -worktrees directory"
  echo "  base-branch defaults to 'master'"
  exit 1
}

# Check for required argument
if [ $# -eq 0 ]; then
  usage
fi

BRANCH_NAME="$1"
BASE_BRANCH="${2:-master}"

# Get current directory name (project name)
PROJECT_DIR=$(basename "$PWD")

# Construct worktrees directory path (parallel to current directory)
PARENT_DIR=$(dirname "$PWD")
WORKTREES_DIR="$PARENT_DIR/${PROJECT_DIR}-worktrees"

# Create worktrees directory if it doesn't exist
if [ ! -d "$WORKTREES_DIR" ]; then
  echo "Creating worktrees directory: $WORKTREES_DIR"
  mkdir -p "$WORKTREES_DIR"
fi

# Create git worktree
WORKTREE_PATH="$WORKTREES_DIR/$BRANCH_NAME"
echo "Creating git worktree: $WORKTREE_PATH"
git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"

# Link .env file if it exists
if [ -f "$PWD/.env" ]; then
  echo "Linking .env file"
  ln -sf "$PWD/.env" "$WORKTREE_PATH/.env"
fi

# Link .claude directory if it exists
if [ -d "$PWD/.claude" ]; then
  echo "Linking .claude directory"
  ln -sf "$PWD/.claude" "$WORKTREE_PATH/.claude"
fi
