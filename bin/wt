#!/bin/bash

set -euo pipefail

# Usage message
usage() {
  echo "Usage: wt <branch-name>"
  echo "  Create a git worktree in a parallel -worktrees directory"
  echo "  and start tmux with claude in a split pane"
  exit 1
}

# Check for required argument
if [ $# -eq 0 ]; then
  usage
fi

BRANCH_NAME="$1"

# Get current directory name (project name)
PROJECT_DIR=$(basename "$PWD")

# Construct worktrees directory path (parallel to current directory)
PARENT_DIR=$(dirname "$PWD")
WORKTREES_DIR="$PARENT_DIR/${PROJECT_DIR}-worktrees"

# Create worktrees directory if it doesn't exist
if [ ! -d "$WORKTREES_DIR" ]; then
  echo "Creating worktrees directory: $WORKTREES_DIR"
  mkdir -p "$WORKTREES_DIR"
fi

# Create git worktree
WORKTREE_PATH="$WORKTREES_DIR/$BRANCH_NAME"
echo "Creating git worktree: $WORKTREE_PATH"
git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH"

# Link .env file if it exists
if [ -f "$PWD/.env" ]; then
  echo "Linking .env file"
  ln -sf "$PWD/.env" "$WORKTREE_PATH/.env"
fi

# Link .claude directory if it exists
if [ -d "$PWD/.claude" ]; then
  echo "Linking .claude directory"
  ln -sf "$PWD/.claude" "$WORKTREE_PATH/.claude"
fi

# Create tmux session name
SESSION_NAME="${PROJECT_DIR}-${BRANCH_NAME}"

# Change to worktree directory
cd "$WORKTREE_PATH"

# Start or attach to tmux session
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "Attaching to existing tmux session: $SESSION_NAME"
  tmux attach-session -t "$SESSION_NAME"
else
  echo "Creating tmux session: $SESSION_NAME"
  tmux new-session -d -s "$SESSION_NAME"
  tmux split-window -h -t "$SESSION_NAME"
  tmux send-keys -t "$SESSION_NAME:0.1" "claude" C-m
  tmux select-pane -t "$SESSION_NAME:0.0"
  tmux attach-session -t "$SESSION_NAME"
fi

