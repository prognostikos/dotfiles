#!/bin/bash

set -euo pipefail

# Usage message
usage() {
  echo "Usage: wt <branch-name> [base-branch]"
  echo "  Create a git worktree in a parallel -worktrees directory"
  echo "  base-branch defaults to 'master'"
  exit 1
}

# Check for required argument
if [ $# -eq 0 ]; then
  usage
fi

BRANCH_NAME="$1"
BASE_BRANCH="${2:-master}"

# Find the main worktree (works from main checkout or any worktree)
MAIN_WORKTREE=$(git worktree list --porcelain | grep -A2 "^worktree " | head -1 | sed 's/^worktree //')
PROJECT_DIR=$(basename "$MAIN_WORKTREE")
PARENT_DIR=$(dirname "$MAIN_WORKTREE")

# Construct worktrees directory path (parallel to main worktree)
WORKTREES_DIR="$PARENT_DIR/${PROJECT_DIR}-worktrees"

# Create worktrees directory if it doesn't exist
if [ ! -d "$WORKTREES_DIR" ]; then
  echo "Creating worktrees directory: $WORKTREES_DIR"
  mkdir -p "$WORKTREES_DIR"
fi

# Create git worktree
WORKTREE_PATH="$WORKTREES_DIR/$BRANCH_NAME"
echo "Creating git worktree: $WORKTREE_PATH"

# Check if branch already exists
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
  echo "Branch '$BRANCH_NAME' already exists, using existing branch"
  git worktree add "$WORKTREE_PATH" "$BRANCH_NAME"
else
  echo "Creating new branch '$BRANCH_NAME' from '$BASE_BRANCH'"
  git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"
fi

# Link .env file if it exists in main worktree
if [ -f "$MAIN_WORKTREE/.env" ]; then
  echo "Linking .env file"
  ln -sf "$MAIN_WORKTREE/.env" "$WORKTREE_PATH/.env"
fi

if [ -f "$WORKTREE_PATH/.envrc" ]; then
  read -r -p "Do you trust the .envrc in the worktree? [y/N]: " response
  case "$response" in
    [yY][eE][sS]|[yY])
      direnv allow "$WORKTREE_PATH"
      ;;
    *)
      false
      ;;
  esac
fi

cd "$WORKTREE_PATH"

tat
